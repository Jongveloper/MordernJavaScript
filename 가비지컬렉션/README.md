# 가비지 컬렉션

자바스크립트는 눈에 보이지 않는 곳에서 메모리 관리를 수행합니다.

원시값, 객체, 함수 등 우리가 만드는 모든 것은 메모리를 차지합니다.
그렇다면 더는 쓸모 없어지게 되면 어떻게 처리될까요?

### 가비지 컬렉션 기준
자바스크립트는 도달 가능성이라는 개념을 사용해 메모리 관리를 수행합니다.
도달가능한 값은 쉽게 말해 어떻게든 접근하거나 사용할 수 있는 값을 의미합니다.
도달 가능한 값은 메모리에서 삭제되지 않습니다.
1. 아래 값들은 태생부터 도달 가능하기 때문에, 명백한 이유 없이는 삭제되지 않습니다.
  예시:
    - 현재 함수의 지역 변수와 매개변수
    - 중첩 함수의 체인에 있는 함수에서 사용되는 변수와 매개변수
    - 전역 변수
    - 기타 등등
    이런 값은 **루트**라고 부릅니다.
2. 루트가 참조하는 값이나 체이닝으로 루트에서 참조할 수 있는 값은 도달 가능한 값이 됩니다.
   전역 변수에 객체가 저장되어있따고 가정했을 때, 이 객체의 프로퍼티가 또 다른 객체를 참조하고 있다면,
   프로퍼티가 참조하는 객체는 도달 가능한 값이 됩니다.
   이 객체가 참조하는 다른 모든 것들도 가능하다고 여겨집니다.

### 간단한 예시
```js
let user = {
  name : 'Jong'
};
```
전역 변수 `user`는 `{name: 'Jong'}`이라는 객체를 참조합니다.
Jong의 프로퍼티 `name`은 원시값을 저장하고 있기 때문에 객체 안에 표현했습니다.
`user`의 값을 다른 값으로 덮어쓰면 참조가 사라집니다.
`user = null`
이제 Jong은 도달할 수 없는 상태가 되었습니다.
가비지 컬렉터는 이제 Jong에 저장된 데이터를 삭제하고, Jong을 메모리에서 삭제합니다.

### 참조 두 개
참조를 `user`에서 `admin`으로 복사했다고 가정해봅시다.
```js
let user = {
  name : 'John'
};

let admin = user;
```
그리고 위에서 한것 처럼 `user`의 값을 다른 값으로 덮어써 봅시다.
`user = null;`
전역 변수 `admin`을 통하면 여전히 객체 John에 접근할 수 있기 때문에
John은 메모리에서 삭제되지 않습니다.
이 상태에서 `admin`을 다른 값으로 덮어쓰면 John은 메모리에서 삭제될 수 있습니다.

### 연결된 객체
복잡한 예시를 살펴보겠습니다.
```js
function marry(man, woman) {
  woman.husband = man;
  man.wife = woman;

  return {
    father: man,
    mother: woman
  }
}

let family = marry({
  name: "John"
}, {
  name: "Ann"
});
```
함수 `marry`는 매개변수로 받은 두 객체를 서로 참조하게 되면서 결혼시키고,
두 객체를 퐇마하는 새로운 객체를 반환합니다.
위의 모든 객체는 도달 가능한 상태입니다.
이제 참조 두 개를 지워보겠습니다.
```js
delete family.father;
delete family.mother.husband
```
삭제한 두 개의 참조 중 하나만 지웠다면, 모든 객체가 여전히 도달 가능한 상태였겠지만,
참조 두 개를 지우면 John으로 들어오는 참조는 모두 사라져
John은 도달 가능한 상태에서 벗어납니다.
외부로 나가는 참조는 도달 가능한 상태에 영향을 주지 않습니다.
외부에서 들어오는 참조만이 도달 가능한 상태에 영향을 줍니다.
John은 이제 도달가능한 상태가 아니기 때문에 메모리에서 제거됩니다.
John에 저장된 데이터(프로퍼티)역시 메모리에서 사리집니다.
### 내부 알고리즘
`mark-and-sweep`이라 불리는 가비지 컬렉션 기본 알고리즘에 대해 알아봅시다.
가바지 컬렉션은 대게 다음 단계를 거쳐 수행됩니다.
- 가비지 컬렉터는 루트 정보를 수집하고 이를 마크합니다.
- 루트가 참조하고있는 모든 객체를 방문하고 이것을 마크합니다.
- 마크된 모든 객체에 방문하고 그 객체들이 참조하는 객체도 마크합니다.
  한번 방문한 객체는 전부 마크하기 때문에 같은 객체를 다시 방문하는 일은 없습니다.
- 루트에서 도달 가능한 모든 객체를 방문할 때까지 위 과정을 반복합니다.
- 마크 되지 않은 모든 객체를 메모리에서 삭제합니다.
